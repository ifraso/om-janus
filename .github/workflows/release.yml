name: Release on Version Change

on:
  push:
    branches: [main, test]
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if version unchanged"
        required: false
        default: false
        type: boolean

jobs:
  check-version:
    name: Check if version changed
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-check.outputs.changed }}
      current-version: ${{ steps.version-check.outputs.current }}
      previous-version: ${{ steps.version-check.outputs.previous }}

    steps:
      - name: Checkout current code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Serve per confrontare con commit precedente

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(python3 -c "import sys; sys.path.insert(0, '.'); from janus import __version__; print(__version__)")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Get previous version
        id: previous
        run: |
          # Get version from previous commit
          PREVIOUS_VERSION=$(git show HEAD~1:janus/__init__.py 2>/dev/null | grep -o '__version__ = "[^"]*"' | cut -d'"' -f2 || echo "unknown")
          echo "version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREVIOUS_VERSION"

      - name: Check version change
        id: version-check
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          PREVIOUS="${{ steps.previous.outputs.version }}"
          FORCE_BUILD="${{ github.event.inputs.force_build }}"

          if [ "$CURRENT" != "$PREVIOUS" ] && [ "$PREVIOUS" != "unknown" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Version changed: $PREVIOUS â†’ $CURRENT"
          elif [ "$PREVIOUS" = "unknown" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… First version detected: $CURRENT"
          elif [ "$FORCE_BUILD" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ğŸ”§ Force build enabled: $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Version unchanged: $CURRENT"
          fi

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

  build-rhel9:
    name: Build for Red Hat Enterprise Linux 9
    needs: check-version
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.version-changed == 'true'
    container:
      image: registry.access.redhat.com/ubi9/ubi:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            python3 \
            python3-pip \
            python3-devel \
            gcc \
            git \
            file \
            tar \
            gzip
          dnf clean all

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt
          python3 -m pip install pyinstaller

      - name: Build executable
        run: |
          python3 -m pyinstaller janus.spec

      - name: Verify build
        run: |
          ls -la dist/
          file dist/janus
          dist/janus version
          echo "Binary size: $(stat -c%s dist/janus | numfmt --to=iec)"

      - name: Prepare release binary
        run: |
          cp dist/janus janus-rhel9
          chmod +x janus-rhel9

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: janus-rhel9-v${{ needs.check-version.outputs.current-version }}
          path: janus-rhel9
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [check-version, build-rhel9]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.version-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: janus-rhel9-v${{ needs.check-version.outputs.current-version }}

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag (if any)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %s" $LAST_TAG..HEAD || echo "- Initial release")
          else
            CHANGELOG="- Initial release"
          fi

          # Save multiline output
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          files: |
            janus-rhel9
          name: "Janus v${{ needs.check-version.outputs.current-version }}"
          tag_name: "v${{ needs.check-version.outputs.current-version }}"
          body: |
            ## ğŸš€ Janus v${{ needs.check-version.outputs.current-version }}

            **MongoDB Migration Tool for Red Hat Enterprise Linux 9**

            ### ğŸ“‹ Changes
            ${{ steps.changelog.outputs.changelog }}

            ### ğŸ“¦ Quick Installation
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ needs.check-version.outputs.current-version }}/janus-rhel9
            chmod +x janus-rhel9
            ./janus-rhel9 version
            ```

            ### ğŸ¯ Platform Support
            - âœ… Red Hat Enterprise Linux 9
            - âœ… CentOS Stream 9
            - âœ… Rocky Linux 9
            - âœ… AlmaLinux 9
            - âœ… Oracle Linux 9

            ### ğŸ”§ Key Features
            - **Alert Configurations**: Export/Import between Ops Manager instances
            - **Database Users & Roles**: Migrate from Ops Manager/Cloud Manager to Atlas
            - **Secure**: Random password generation with CSV export
            - **Interactive**: Project selection and mapping
            - **Standalone**: No Python installation required

            ### ğŸ“š Documentation
            - [Usage Examples](https://github.com/${{ github.repository }}#running-janus)
            - [Configuration Guide](https://github.com/${{ github.repository }}/tree/main/docs/examples)
            - [Building from Source](https://github.com/${{ github.repository }}#building-standalone-executable)

            ---

            **Build Info:** `${{ github.sha }}` â€¢ **Platform:** Red Hat UBI9

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success notification
        run: |
          echo "ğŸ‰ Release v${{ needs.check-version.outputs.current-version }} created successfully!"
          echo "ğŸ“¦ Binary: janus-rhel9"
          echo "ğŸ“ URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-version.outputs.current-version }}"
