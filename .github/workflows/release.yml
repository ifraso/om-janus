name: Release on Version Change

on:
  push:
    branches: [main, test]
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if version unchanged"
        required: false
        default: false
        type: boolean

jobs:
  check-version:
    name: Check if version changed
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-check.outputs.changed }}
      current-version: ${{ steps.version-check.outputs.current }}
      previous-version: ${{ steps.version-check.outputs.previous }}

    steps:
      - name: Checkout current code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Serve per confrontare con commit precedente

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(python3 -c "import sys; sys.path.insert(0, '.'); from janus import __version__; print(__version__)")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Get previous version
        id: previous
        run: |
          # Get version from previous commit
          PREVIOUS_VERSION=$(git show HEAD~1:janus/__init__.py 2>/dev/null | grep -o '__version__ = "[^"]*"' | cut -d'"' -f2 || echo "unknown")
          echo "version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREVIOUS_VERSION"

      - name: Check version change
        id: version-check
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          PREVIOUS="${{ steps.previous.outputs.version }}"
          FORCE_BUILD="${{ github.event.inputs.force_build }}"

          if [ "$CURRENT" != "$PREVIOUS" ] && [ "$PREVIOUS" != "unknown" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Version changed: $PREVIOUS ‚Üí $CURRENT"
          elif [ "$PREVIOUS" = "unknown" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ First version detected: $CURRENT"
          elif [ "$FORCE_BUILD" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üîß Force build enabled: $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Version unchanged: $CURRENT"
          fi

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

  build-rhel9:
    name: Build for Red Hat Enterprise Linux 9
    needs: check-version
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.version-changed == 'true'
    container:
      image: registry.access.redhat.com/ubi9/ubi:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            python3 \
            python3-pip \
            python3-devel \
            gcc \
            git \
            file \
            tar \
            gzip
          dnf clean all

      - name: Create virtual environment and install dependencies
        run: |
          python3 -m venv /opt/janus-venv
          source /opt/janus-venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          source /opt/janus-venv/bin/activate
          pyinstaller janus.spec

      - name: Verify build
        run: |
          ls -la dist/
          file dist/janus
          dist/janus version
          echo "Binary size: $(stat -c%s dist/janus | numfmt --to=iec)"

      - name: Prepare release binary
        run: |
          cp dist/janus janus
          chmod +x janus

      - name: Upload binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: janus-v${{ needs.check-version.outputs.current-version }}
          path: janus
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: [check-version, build-rhel9]
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.version-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: janus-v${{ needs.check-version.outputs.current-version }}

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag (if any)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %s" $LAST_TAG..HEAD || echo "- Initial release")
          else
            CHANGELOG="- Initial release"
          fi

          # Save multiline output
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          files: |
            janus
          name: "Janus v${{ needs.check-version.outputs.current-version }}"
          tag_name: "v${{ needs.check-version.outputs.current-version }}"
          body: |
            ## Janus v${{ needs.check-version.outputs.current-version }}

            ${{ steps.changelog.outputs.changelog }}

            ### Installation
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ needs.check-version.outputs.current-version }}/janus
            chmod +x janus
            ./janus version
            ```

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success notification
        run: |
          echo "üéâ Release v${{ needs.check-version.outputs.current-version }} created successfully!"
          echo "üì¶ Binary: janus"
          echo "üìç URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-version.outputs.current-version }}"
