name: Release on Version Change

on:
  push:
    branches: [main, test]
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if version unchanged"
        required: false
        default: false
        type: boolean

jobs:
  check-version:
    name: Check if version changed
    runs-on: ubuntu-latest
    outputs:
      version-changed: ${{ steps.version-check.outputs.changed }}
      current-version: ${{ steps.version-check.outputs.current }}
      previous-version: ${{ steps.version-check.outputs.previous }}

    steps:
      - name: Checkout current code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Serve per confrontare con commit precedente

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(python3 -c "import sys; sys.path.insert(0, '.'); from janus import __version__; print(__version__)")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Get previous version
        id: previous
        run: |
          # Get version from previous commit
          PREVIOUS_VERSION=$(git show HEAD~1:janus/__init__.py 2>/dev/null | grep -o '__version__ = "[^"]*"' | cut -d'"' -f2 || echo "unknown")
          echo "version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREVIOUS_VERSION"

      - name: Check version change
        id: version-check
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          PREVIOUS="${{ steps.previous.outputs.version }}"
          FORCE_BUILD="${{ github.event.inputs.force_build }}"

          if [ "$CURRENT" != "$PREVIOUS" ] && [ "$PREVIOUS" != "unknown" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Version changed: $PREVIOUS ‚Üí $CURRENT"
          elif [ "$PREVIOUS" = "unknown" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ First version detected: $CURRENT"
          elif [ "$FORCE_BUILD" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üîß Force build enabled: $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Version unchanged: $CURRENT"
          fi

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

  build-and-release:
    name: Build and Release
    needs: check-version
    runs-on: ubuntu-latest
    if: needs.check-version.outputs.version-changed == 'true'
    container:
      image: registry.access.redhat.com/ubi9/ubi:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          dnf install -y \
            python3 \
            python3-pip \
            python3-devel \
            gcc \
            git \
            file \
            tar \
            gzip
          dnf clean all

      - name: Create virtual environment and install dependencies
        run: |
          python3 -m venv /opt/janus-venv
          source /opt/janus-venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          source /opt/janus-venv/bin/activate
          pyinstaller janus.spec

      - name: Verify build and prepare binary
        run: |
          ls -la dist/
          file dist/janus
          dist/janus version
          echo "Binary size: $(stat -c%s dist/janus | numfmt --to=iec)"

          # Debug current directory
          echo "Current directory contents:"
          ls -la .

          # Remove any existing janus file/directory
          rm -rf janus

          # Prepare final binary with absolute paths
          cp dist/janus janus-binary
          chmod +x janus-binary

          # Verify the copy worked
          ls -la janus-binary
          file janus-binary
          ./janus-binary version

          # Rename to final name
          mv janus-binary janus

      - name: Generate changelog
        id: changelog
        run: |
          # Use the commit message from GitHub context
          CHANGELOG="- ${{ github.event.head_commit.message }}"

          # Save multiline output
          {
            echo "changelog<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          files: |
            janus
          name: "v${{ needs.check-version.outputs.current-version }}"
          tag_name: "v${{ needs.check-version.outputs.current-version }}"
          body: |
            ## Release Notes

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ needs.check-version.outputs.current-version }}/janus
            chmod +x janus
            ./janus version
            ```

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Success notification
        run: |
          echo "üéâ Release v${{ needs.check-version.outputs.current-version }} created successfully!"
          echo "üì¶ Binary: janus"
          echo "üìç URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-version.outputs.current-version }}"
